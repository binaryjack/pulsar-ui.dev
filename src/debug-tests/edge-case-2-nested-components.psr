/**
 * Edge Case 2: Nested Components - PSR Version
 * Testing component composition with RenderCapture validation
 */

import { useState, useEffect } from '@pulsar-framework/pulsar.dev';
import { captureRender, compareWithExpected } from '../tests/render-capture';

// GrandChild component (deepest level)
component GrandChild({ value }: { value: string }) {
  return (
    <div style="padding: 1rem; background: #faf089; border-radius: 6px; border-left: 4px solid #ecc94b;">
      <strong style="color: #744210;">ðŸ‘¶ GrandChild:</strong> {value}
    </div>
  );
}

// Child component (middle level)
component Child({ title, children }: { title: string; children?: any }) {
  const [expanded, setExpanded] = useState<boolean>(true);

  return (
    <div style="margin-top: 1rem; padding: 1rem; background: #bee3f8; border-radius: 8px; border-left: 4px solid #4299e1;">
      <div 
        onClick={() => setExpanded(!expanded())}
        style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
      >
        <strong style="color: #2c5282;">ðŸ‘§ Child: {title}</strong>
        <span>{expanded() ? 'â–¼' : 'â–¶'}</span>
      </div>
      
      {expanded() && (
        <div style="margin-top: 1rem;">
          {children}
        </div>
      )}
    </div>
  );
}

// Parent component (top level)
component Parent({ onRenderCapture }: { onRenderCapture?: (result: string) => void }) {
  const [childCount, setChildCount] = useState<number>(2);
  const [captureResult, setCaptureResult] = useState<string>('Pending...');

  useEffect(() => {
    const rootEl = document.querySelector('[data-test-id="nested-root"]');
    if (rootEl) {
      const capture = captureRender(rootEl as HTMLElement, 'Parent');
      const comparison = compareWithExpected(capture, {
        componentName: 'Parent',
        assertions: {
          dom: {
            tagName: 'div',
            minChildren: 3,
            textContains: ['Parent Component', 'Child', 'GrandChild'],
          },
          a11y: {
            minChildrenDepth: 3,
          },
        },
      });
      
      const result = comparison.passed ? 'âœ… PASS' : `âŒ FAIL: ${comparison.failures.join(', ')}`;
      setCaptureResult(result);
      if (onRenderCapture) {
        onRenderCapture(result);
      }
      
      console.log('[PSR Test] Nested Components Capture:', capture);
      console.log('[PSR Test] Comparison:', comparison);
    }
  });

  const generateChildren = () => {
    const children = [];
    for (let i = 0; i < childCount(); i++) {
      children.push(
        <Child key={i} title={`Child ${i + 1}`}>
          <GrandChild value={`Data from Child ${i + 1}`} />
          {i === 0 && <GrandChild value="Extra nested data" />}
        </Child>
      );
    }
    return children;
  };

  return (
    <div data-test-id="nested-root" style="padding: 1.5rem; background: #c6f6d5; border-radius: 12px; border-left: 4px solid #48bb78;">
      <h3 style="margin: 0 0 1rem; color: #22543d;">ðŸ‘¨ Parent Component</h3>
      
      <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.6); border-radius: 8px;">
        <strong>RenderCapture:</strong> {captureResult()}
      </div>

      <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <button
          onClick={() => setChildCount(Math.max(1, childCount() - 1))}
          style="padding: 0.5rem 1rem; background: #fc8181; color: white; border: none; border-radius: 6px; cursor: pointer;"
        >
          - Remove Child
        </button>
        <span style="padding: 0.5rem 1rem; background: white; border-radius: 6px; font-weight: bold;">
          {childCount()} Children
        </span>
        <button
          onClick={() => setChildCount(childCount() + 1)}
          style="padding: 0.5rem 1rem; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer;"
        >
          + Add Child
        </button>
      </div>

      {generateChildren()}
    </div>
  );
}

// Main test component
component EdgeCase2NestedComponentsPSR() {
  const [captureStatus, setCaptureStatus] = useState<string>('');

  return (
    <div style="padding: 2rem; max-width: 800px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 2rem; border-radius: 12px; color: white; margin-bottom: 2rem;">
        <h1 style="margin: 0 0 0.5rem; font-size: 2rem;">ðŸŸ  Test 2: Nested Components (PSR)</h1>
        <p style="margin: 0; opacity: 0.9;">Testing component composition and prop passing</p>
        
        {captureStatus() && (
          <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.2); border-radius: 8px;">
            <strong>Status:</strong> {captureStatus()}
          </div>
        )}
      </div>

      <Parent onRenderCapture={setCaptureStatus} />

      <div style="margin-top: 2rem; padding: 1.5rem; background: #edf2f7; border-radius: 12px;">
        <h3 style="margin: 0 0 1rem; color: #2d3748;">ðŸ§ª What's Being Tested:</h3>
        <ul style="margin: 0; padding-left: 1.5rem; color: #4a5568; line-height: 1.8;">
          <li>PSR component composition (Parent â†’ Child â†’ GrandChild)</li>
          <li>Props passing through component hierarchy</li>
          <li>Children prop handling in PSR</li>
          <li>Nested useState() hooks</li>
          <li>Dynamic component generation</li>
          <li>RenderCapture depth validation</li>
        </ul>
      </div>

      <div style="margin-top: 2rem; padding: 1.5rem; background: #2d3748; border-radius: 12px; color: #e2e8f0; font-family: monospace; font-size: 0.9rem; overflow-x: auto;">
        <div style="color: #48bb78; margin-bottom: 0.5rem;">// PSR Component Hierarchy:</div>
        <div>{`component Parent() {`}</div>
        <div>{`  return <Child>`}</div>
        <div>{`    <GrandChild value="nested data" />`}</div>
        <div>{`  </Child>;`}</div>
        <div>{`}`}</div>
      </div>
    </div>
  );
}

export { EdgeCase2NestedComponentsPSR, Parent, Child, GrandChild };
