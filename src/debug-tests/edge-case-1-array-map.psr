/**
 * Edge Case 1: Array Mapping - PSR Version
 * Testing array.map() transformation with RenderCapture validation
 */

import { useState, useEffect } from '@pulsar-framework/pulsar.dev';
import { captureRender, compareWithExpected } from '../tests/render-capture';

component EdgeCase1ArrayMapPSR() {
  const [items, setItems] = useState<string[]>(['Item 1', 'Item 2', 'Item 3']);
  const [filterActive, setFilterActive] = useState<boolean>(false);
  const [captureResult, setCaptureResult] = useState<string>('');

  // Capture render on mount
  useEffect(() => {
    const rootEl = document.querySelector('[data-test-id="array-map-root"]');
    if (rootEl) {
      const capture = captureRender(rootEl as HTMLElement, 'EdgeCase1ArrayMapPSR');
      const comparison = compareWithExpected(capture, {
        componentName: 'EdgeCase1ArrayMapPSR',
        assertions: {
          dom: {
            tagName: 'div',
            minChildren: 2,
            textContains: ['Array Mapping Test', 'Item 1', 'Item 2', 'Item 3'],
          },
        },
      });
      
      setCaptureResult(comparison.passed ? 'âœ… PASS' : `âŒ FAIL: ${comparison.failures.join(', ')}`);
      console.log('[PSR Test] Array Mapping Capture:', capture);
      console.log('[PSR Test] Comparison:', comparison);
    }
  });

  const addItem = () => {
    const newNum = items().length + 1;
    setItems([...items(), `Item ${newNum}`]);
  };

  const removeItem = (index: number) => {
    setItems(items().filter((_, i) => i !== index));
  };

  const filteredItems = () => {
    if (!filterActive()) return items();
    return items().filter(item => item.includes('1') || item.includes('2'));
  };

  return (
    <div data-test-id="array-map-root" style="padding: 2rem; max-width: 800px; margin: 0 auto;">
      {/* Test Header */}
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 12px; color: white; margin-bottom: 2rem;">
        <h1 style="margin: 0 0 0.5rem; font-size: 2rem;">ðŸ”´ Test 1: Array Mapping (PSR)</h1>
        <p style="margin: 0; opacity: 0.9;">Testing array.map() transformation in PSR syntax</p>
        
        {/* Capture Status */}
        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.2); border-radius: 8px;">
          <strong>RenderCapture Status:</strong> {captureResult()}
        </div>
      </div>

      {/* Controls */}
      <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
        <button
          onClick={addItem}
          style="flex: 1; padding: 1rem; background: #48bb78; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: transform 0.2s;"
          onMouseOver={(e: MouseEvent) => (e.currentTarget as HTMLElement).style.transform = 'scale(1.05)'}
          onMouseOut={(e: MouseEvent) => (e.currentTarget as HTMLElement).style.transform = 'scale(1)'}
        >
          âž• Add Item ({items().length})
        </button>
        
        <button
          onClick={() => setFilterActive(!filterActive())}
          style={`flex: 1; padding: 1rem; background: ${filterActive() ? '#f56565' : '#4299e1'}; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: transform 0.2s;`}
          onMouseOver={(e: MouseEvent) => (e.currentTarget as HTMLElement).style.transform = 'scale(1.05)'}
          onMouseOut={(e: MouseEvent) => (e.currentTarget as HTMLElement).style.transform = 'scale(1)'}
        >
          {filterActive() ? 'ðŸ”´ Filter ON' : 'âšª Filter OFF'}
        </button>
      </div>

      {/* Array Map Test - THE CRITICAL TRANSFORMATION */}
      <div style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="margin: 0 0 1rem; color: #2d3748;">
          Rendered Items (Total: {filteredItems().length})
        </h2>
        
        <div style="display: grid; gap: 1rem;">
          {filteredItems().map((item, index) => (
            <div
              key={index}
              style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;"
            >
              <span style="font-size: 1.1rem; color: #2d3748;">{item}</span>
              <button
                onClick={() => removeItem(index)}
                style="padding: 0.5rem 1rem; background: #fc8181; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.2s;"
                onMouseOver={(e: MouseEvent) => (e.currentTarget as HTMLElement).style.background = '#f56565'}
                onMouseOut={(e: MouseEvent) => (e.currentTarget as HTMLElement).style.background = '#fc8181'}
              >
                Remove
              </button>
            </div>
          ))}
        </div>
      </div>

      {/* What's Being Tested */}
      <div style="margin-top: 2rem; padding: 1.5rem; background: #edf2f7; border-radius: 12px;">
        <h3 style="margin: 0 0 1rem; color: #2d3748;">ðŸ§ª What's Being Tested:</h3>
        <ul style="margin: 0; padding-left: 1.5rem; color: #4a5568; line-height: 1.8;">
          <li><code>items().map()</code> transformation in PSR</li>
          <li>Reactive signal updates triggering re-renders</li>
          <li>Conditional filtering with <code>filter()</code></li>
          <li>Event handlers in mapped elements</li>
          <li>RenderCapture validation of DOM output</li>
        </ul>
      </div>

      {/* Code Example */}
      <div style="margin-top: 2rem; padding: 1.5rem; background: #2d3748; border-radius: 12px; color: #e2e8f0; font-family: monospace; font-size: 0.9rem; overflow-x: auto;">
        <div style="color: #48bb78; margin-bottom: 0.5rem;">// PSR Source Code:</div>
        <div>{`{filteredItems().map((item, index) => (`}</div>
        <div>{`  <div key={index}>`}</div>
        <div>{`    <span>{item}</span>`}</div>
        <div>{`    <button onClick={() => removeItem(index)}>Remove</button>`}</div>
        <div>{`  </div>`}</div>
        <div>{`))}`}</div>
      </div>
    </div>
  );
}

export { EdgeCase1ArrayMapPSR };
