import {
  createSignal,
  createEffect,
  createMemo,
  createContext,
  useContext,
  ForRegistry,
  ShowRegistry,
} from '@pulsar-framework/pulsar.dev';

// TEST 1: SIGNALS
const SignalTest = (): HTMLElement => {
  const [count, setCount] = createSignal(0);
  const [text, setText] = createSignal('Hello Pulsar');

  return (
    <div style="padding: 20px; background: white; margin: 10px; border-radius: 8px;">
      <h3>1. Signal Reactivity Test</h3>
      <p>Count: <strong>{count()}</strong></p>
      <p>Text: <strong>{text()}</strong></p>
      <button onClick={() => setCount(count() + 1)}>Increment</button>
      <button onClick={() => setCount(0)}>Reset</button>
      <input 
        type="text" 
        value={text()} 
        onInput={(e) => setText(e.target.value)}
        style="margin-left: 10px; padding: 5px;"
      />
    </div>
  );
};

// TEST 2: EFFECTS  
const EffectTest = (): HTMLElement => {
  const [input, setInput] = createSignal('');
  const [log, setLog] = createSignal<string[]>([]);

  createEffect(() => {
    const val = input();
    if (val) {
      setLog([...log(), `Input: ${val}`]);
    }
  });

  return (
    <div style="padding: 20px; background: white; margin: 10px; border-radius: 8px;">
      <h3>2. Effect Reactivity Test</h3>
      <input
        type="text"
        value={input()}
        onInput={(e) => setInput(e.target.value)}
        placeholder="Type here..."
        style="padding: 5px; width: 200px;"
      />
      <div style="margin-top: 10px; max-height: 150px; overflow-y: auto; background: #f5f5f5; padding: 10px;">
        {log().map((entry, i) => (
          <div key={i}>{entry}</div>
        ))}
      </div>
    </div>
  );
};

// TEST 3: MEMOS
const MemoTest = (): HTMLElement => {
  const [firstName, setFirstName] = createSignal('John');
  const [lastName, setLastName] = createSignal('Doe');

  const fullName = createMemo(() => `${firstName()} ${lastName()}`);
  const initials = createMemo(() => `${firstName()[0]}${lastName()[0]}`);

  return (
    <div style="padding: 20px; background: white; margin: 10px; border-radius: 8px;">
      <h3>3. Memo (Computed Values) Test</h3>
      <div>
        <label>First Name: </label>
        <input
          type="text"
          value={firstName()}
          onInput={(e) => setFirstName(e.target.value)}
          style="padding: 5px; margin: 5px;"
        />
      </div>
      <div>
        <label>Last Name: </label>
        <input
          type="text"
          value={lastName()}
          onInput={(e) => setLastName(e.target.value)}
          style="padding: 5px; margin: 5px;"
        />
      </div>
      <p>Full Name: <strong>{fullName()}</strong></p>
      <p>Initials: <strong>{initials()}</strong></p>
    </div>
  );
};

// TEST 4: CONTROL FLOW
interface TodoItem {
  id: number;
  text: string;
  done: boolean;
}

const ControlFlowTest = (): HTMLElement => {
  const [todos, setTodos] = createSignal<TodoItem[]>([
    { id: 1, text: 'Test ForRegistry', done: false },
    { id: 2, text: 'Test ShowRegistry', done: false },
    { id: 3, text: 'Test Control Flow', done: true },
  ]);
  const [newTodo, setNewTodo] = createSignal('');

  const addTodo = () => {
    const text = newTodo().trim();
    if (text) {
      setTodos([...todos(), { id: Date.now(), text, done: false }]);
      setNewTodo('');
    }
  };

  const toggleTodo = (id: number) => {
    setTodos(todos().map(t => t.id === id ? { ...t, done: !t.done } : t));
  };

  const deleteTodo = (id: number) => {
    setTodos(todos().filter(t => t.id !== id));
  };

  return (
    <div style="padding: 20px; background: white; margin: 10px; border-radius: 8px;">
      <h3>4. Control Flow (ForRegistry and ShowRegistry)</h3>
      <div style="margin-bottom: 10px;">
        <input
          type="text"
          value={newTodo()}
          onInput={(e) => setNewTodo(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && addTodo()}
          placeholder="Add new todo..."
          style="padding: 5px; width: 200px;"
        />
        <button onClick={addTodo} style="margin-left: 5px;">Add</button>
      </div>
      <ShowRegistry when={todos().length > 0} fallback={<p>No todos yet</p>}>
        <ForRegistry each={todos()}>
          {(todo, index) => (
            <div 
              key={todo().id}
              style={`padding: 10px; margin: 5px 0; background: ${todo().done ? '#e0e0e0' : '#f9f9f9'}; border-radius: 4px; display: flex; align-items: center;`}
            >
              <input
                type="checkbox"
                checked={todo().done}
                onChange={() => toggleTodo(todo().id)}
                style="margin-right: 10px;"
              />
              <span style={`flex: 1; ${todo().done ? 'text-decoration: line-through; opacity: 0.6;' : ''}`}>
                {index() + 1}. {todo().text}
              </span>
              <button onClick={() => deleteTodo(todo().id)} style="padding: 2px 8px;">Delete</button>
            </div>
          )}
        </ForRegistry>
      </ShowRegistry>
    </div>
  );
};

// TEST 5: LIVE TEXT MIRRORING
const TextMirroringTest = (): HTMLElement => {
  const [sourceText, setSourceText] = createSignal('');

  const upperCase = createMemo(() => sourceText().toUpperCase());
  const lowerCase = createMemo(() => sourceText().toLowerCase());
  const charCount = createMemo(() => sourceText().length);

  return (
    <div style="padding: 20px; background: white; margin: 10px; border-radius: 8px;">
      <h3>5. Live Text Mirroring Test</h3>
      <textarea
        value={sourceText()}
        onInput={(e) => setSourceText(e.target.value)}
        placeholder="Type something here..."
        style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace;"
      />
      <p>Character Count: <strong>{charCount()}</strong></p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
        <div style="padding: 10px; background: #e3f2fd; border-radius: 4px;">
          <h4 style="margin-top: 0;">Original</h4>
          <div style="font-family: monospace;">{sourceText() || '(empty)'}</div>
        </div>
        <div style="padding: 10px; background: #f1f8e9; border-radius: 4px;">
          <h4 style="margin-top: 0;">UPPERCASE</h4>
          <div style="font-family: monospace;">{upperCase() || '(empty)'}</div>
        </div>
        <div style="padding: 10px; background: #fff3e0; border-radius: 4px;">
          <h4 style="margin-top: 0;">lowercase</h4>
          <div style="font-family: monospace;">{lowerCase() || '(empty)'}</div>
        </div>
      </div>
    </div>
  );
};

// MAIN APP
const ComprehensiveReactivityTestSuite = (): HTMLElement => {
  return (
    <div style="font-family: system-ui, -apple-system, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f0f2f5;">
      <header style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; margin-bottom: 30px;">
        <h1 style="margin: 0;">Pulsar Framework</h1>
        <h2 style="margin: 10px 0 0 0; font-weight: 400;">Comprehensive Reactivity Test Suite</h2>
      </header>
      
      <SignalTest />
      <EffectTest />
      <MemoTest />
      <ControlFlowTest />
      <TextMirroringTest />
      
      <footer style="text-align: center; padding: 20px; margin-top: 20px; color: #666;">
        <p>Pulsar Framework Reactivity Tests - All features working correctly</p>
      </footer>
    </div>
  );
};

export default ComprehensiveReactivityTestSuite;
