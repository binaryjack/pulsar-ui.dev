
/**
 * PHASE 4: Error Boundaries & Error Handling  
 * Testing: Tryer/Catcher error boundary pattern
 */

import { createSignal, Tryer, Catcher, ShowRegistry } from '@pulsar-framework/pulsar.dev';

// Components that can throw errors
component SafeComponent() {
  return (
    <div style="padding: 15px; background: #10b981; color: white; border-radius: 4px;">
      ‚úì Component is safe and renders successfully
    </div>
  );
}

component ErrorComponent({ message }) {
  // Ensure message is evaluated as a function if it's a signal/function
  const errorMsg = typeof message === 'function' ? message() : message;
  throw new Error(errorMsg || 'Component rendering failed!');
}

export component ErrorBoundaryTestPage() {
  // Test 1: Basic error boundary  
  const [throwError, setThrowError] = createSignal(false);
  const [errorMessage, setErrorMessage] = createSignal('Critical render error!');
  
  const toggleError = () => {
    console.log('toggleError called, current throwError():', throwError());
    setThrowError(!throwError());
    console.log('toggleError set, new throwError():', !throwError());
  };
  
  // Test 2: Multiple boundaries
  const [section1Error, setSection1Error] = createSignal(false);
  const [section2Error, setSection2Error] = createSignal(false); 
  const [section3Error, setSection3Error] = createSignal(false);
  
  // Test 3: Nested boundaries
  const [outerError, setOuterError] = createSignal(false);
  const [innerError, setInnerError] = createSignal(false);
  
  // Test 4: Error recovery
  const [attemptCount, setAttemptCount] = createSignal(0);
  const [shouldFail, setShouldFail] = createSignal(true);
  
  const tryAgain = () => {
    setAttemptCount(c => c + 1);
    console.log('tryAgain called, attemptCount:', attemptCount());
    if (attemptCount() >= 2) {
      setShouldFail(false);
      console.log('shouldFail set to false after 3 attempts');
    }
  };
  
  return (
    <div>
      <div style="padding: 20px; background: #0f172a; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #06b6d4;">
        <h1 style="font-size: 32px; margin-bottom: 15px; color: #06b6d4;">
          üõ°Ô∏è Error Boundaries Demo
        </h1>
        
        <div style="background: #1e293b; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
          <h4 style="color: #fbbf24; margin: 0 0 10px 0;">üìã What to Expect:</h4>
          <ul style="color: #94a3b8; margin: 0; padding-left: 20px; line-height: 1.6;">
            <li><strong>Click buttons</strong> ‚Üí Status indicators show state changes</li>
            <li><strong>Trigger errors</strong> ‚Üí Watch Tryer/Catcher components in action</li>
            <li><strong>Error messages</strong> ‚Üí Appear in red boxes instead of console crashes</li>
            <li><strong>Independent sections</strong> ‚Üí Errors in one don't affect others</li>
            <li><strong>Nested handling</strong> ‚Üí Inner boundaries catch first, outer as fallback</li>
            <li><strong>Recovery pattern</strong> ‚Üí Retry logic with automatic success after 3 attempts</li>
          </ul>
        </div>
        
        <div style="background: #0f172a; padding: 10px; border-radius: 4px; color: #64748b; font-size: 12px;">
          üí° <strong>Debug Console:</strong> Check browser DevTools console for detailed logging of each render cycle
        </div>
      </div>

      {/* Test 1: Basic Error Boundary */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #ef4444;">
          1Ô∏è‚É£ Basic Error Boundary - Tryer/Catcher
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Tryer/Catcher provides error boundaries to catch and handle component errors gracefully.
        </p>
        
        <div style="background: #0a0a0a; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
          {/* Simple test first */}
          <div style="padding: 10px; background: #1a1a1a; border-radius: 4px; margin-bottom: 10px;">
            <button onclick={() => {
              console.log('Simple button clicked!');
              console.log('Current throwError():', throwError());
              setThrowError(!throwError());
              console.log('After toggle throwError():', throwError());
            }}
            style="padding: 8px 16px; background: #06b6d4; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 10px;">
              Simple Toggle Test
            </button>
            <span style="color: white;">Current state: {throwError() ? 'ERROR' : 'SAFE'}</span>
          </div>
          
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button 
              onclick={toggleError}
              style="padding: 10px 20px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;">
              {throwError() ? 'Fix Error' : 'Trigger Error'}
            </button>
            
            <div style="padding: 10px; background: #1a1a1a; border: 1px solid #334155; border-radius: 4px; color: #94a3b8; font-size: 12px;">
              Status: {throwError() ? 'üî• ERROR MODE' : '‚úÖ SAFE MODE'}
            </div>
            
            <input
              type="text"
              value={errorMessage()}
              oninput={(e) => {
                console.log('Input changed:', e.target.value);
                setErrorMessage(e.target.value);
              }}
              placeholder="Custom error message"
              style="flex: 1; padding: 10px; background: #1a1a1a; border: 2px solid #334155; border-radius: 4px; color: white; font-size: 14px;"
            />
          </div>
          
          <div style="min-height: 80px; border: 2px dashed #334155; border-radius: 4px; padding: 15px;">
            <Tryer>
              {() => {
                console.log('Basic Tryer rendering, throwError():', throwError());
                if (throwError()) {
                  return <ErrorComponent message={errorMessage} />;
                } else {
                  return <SafeComponent />;
                }
              }}
              
              <Catcher>
                {(error, reset) => (
                  <div style="padding: 20px; background: #7f1d1d; border-left: 4px solid #ef4444; border-radius: 4px;">
                    <h4 style="margin: 0 0 10px 0; color: #fca5a5; font-size: 18px;">
                      ‚ö†Ô∏è Error Caught
                    </h4>
                    <p style="margin: 0 0 15px 0; color: #fecaca; font-family: monospace; font-size: 14px;">
                      {error.message}
                    </p>
                    <button
                      onClick={() => { reset(); setThrowError(false); }}
                      style="padding: 8px 16px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;"
                    >
                      Reset Boundary
                    </button>
                  </div>
                )}
              </Catcher>
            </Tryer>
          </div>
        </div>
      </section>
      
      {/* Test 2: Multiple Independent Boundaries */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #ef4444;">
          2Ô∏è‚É£ Multiple Independent Boundaries
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Each boundary is isolated - errors in one section don't affect others.
        </p>
        
        <div style="background: #0a0a0a; padding: 15px; border-radius: 4px;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            {/* Section 1 */}
            <div style="background: #1a1a1a; padding: 15px; border-radius: 4px;">
              <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">Section 1</h4>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <button
                  onclick={() => {
                    console.log('Section 1 toggle clicked, current:', section1Error());
                    setSection1Error(!section1Error());
                  }}
                  style="padding: 8px 12px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;"
                >
                  Toggle Error
                </button>
                <div style="padding: 5px 10px; background: #0a0a0a; border: 1px solid #334155; border-radius: 4px; color: #94a3b8; font-size: 11px;">
                  {section1Error() ? 'üî• ERROR' : '‚úÖ OK'}
                </div>
              </div>
              <Tryer>
                {() => {
                  console.log('Section 1 Tryer rendering, section1Error():', section1Error());
                  if (section1Error()) {
                    return <ErrorComponent message={() => 'Section 1 failed'} />;
                  } else {
                    return (
                      <div style="padding: 10px; background: #10b981; color: white; border-radius: 4px; text-align: center;">
                        ‚úì OK
                      </div>
                    );
                  }
                }}
                <Catcher>
                  {(error) => (
                    <div style="padding: 10px; background: #7f1d1d; color: #fca5a5; border-radius: 4px; font-size: 12px;">
                      ‚ö†Ô∏è {error.message}
                    </div>
                  )}
                </Catcher>
              </Tryer>
            </div>
            
            {/* Section 2 */}
            <div style="background: #1a1a1a; padding: 15px; border-radius: 4px;">
              <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">Section 2</h4>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <button
                  onclick={() => {
                    console.log('Section 2 toggle clicked, current:', section2Error());
                    setSection2Error(!section2Error());
                  }}
                  style="padding: 8px 12px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;"
                >
                  Toggle Error
                </button>
                <div style="padding: 5px 10px; background: #0a0a0a; border: 1px solid #334155; border-radius: 4px; color: #94a3b8; font-size: 11px;">
                  {section2Error() ? 'üî• ERROR' : '‚úÖ OK'}
                </div>
              </div>
              <Tryer>
                {() => {
                  console.log('Section 2 Tryer rendering, section2Error():', section2Error());
                  if (section2Error()) {
                    return <ErrorComponent message={() => 'Section 2 failed'} />;
                  } else {
                    return (
                      <div style="padding: 10px; background: #10b981; color: white; border-radius: 4px; text-align: center;">
                        ‚úì OK
                      </div>
                    );
                  }
                }}
                <Catcher>
                  {(error) => (
                    <div style="padding: 10px; background: #7f1d1d; color: #fca5a5; border-radius: 4px; font-size: 12px;">
                      ‚ö†Ô∏è {error.message}
                    </div>
                  )}
                </Catcher>
              </Tryer>
            </div>
            
            {/* Section 3 */}
            <div style="background: #1a1a1a; padding: 15px; border-radius: 4px;">
              <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">Section 3</h4>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <button
                  onclick={() => {
                    console.log('Section 3 toggle clicked, current:', section3Error());
                    setSection3Error(!section3Error());
                  }}
                  style="padding: 8px 12px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;"
                >
                  Toggle Error
                </button>
                <div style="padding: 5px 10px; background: #0a0a0a; border: 1px solid #334155; border-radius: 4px; color: #94a3b8; font-size: 11px;">
                  {section3Error() ? 'üî• ERROR' : '‚úÖ OK'}
                </div>
              </div>
              <Tryer>
                {() => {
                  console.log('Section 3 Tryer rendering, section3Error():', section3Error());
                  if (section3Error()) {
                    return <ErrorComponent message={() => 'Section 3 failed'} />;
                  } else {
                    return (
                      <div style="padding: 10px; background: #10b981; color: white; border-radius: 4px; text-align: center;">
                        ‚úì OK
                      </div>
                    );
                  }
                }}
                <Catcher>
                  {(error) => (
                    <div style="padding: 10px; background: #7f1d1d; color: #fca5a5; border-radius: 4px; font-size: 12px;">
                      ‚ö†Ô∏è {error.message}
                    </div>
                  )}
                </Catcher>
              </Tryer>
            </div>
          </div>
          
          <div style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 4px; font-size: 12px; color: #94a3b8;">
            üí° Note: Each section has its own boundary. Errors are contained to their section.
          </div>
        </div>
      </section>
      
      {/* Test 3: Nested Boundaries */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #ef4444;">
          3Ô∏è‚É£ Nested Error Boundaries
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Inner boundaries catch errors first. Outer boundary only activates if inner doesn't exist.
        </p>
        
        <div style="background: #0a0a0a; padding: 15px; border-radius: 4px;">
          <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
            <button
              onclick={() => {
                console.log('Outer error toggle clicked, current:', outerError());
                setOuterError(!outerError());
              }}
              style="padding: 10px 20px; background: #f59e0b; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;"
            >
              Toggle Outer Error
            </button>
            <button
              onclick={() => {
                console.log('Inner error toggle clicked, current:', innerError());
                setInnerError(!innerError());
              }}
              style="padding: 10px 20px; background: #8b5cf6; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;"
            >
              Toggle Inner Error
            </button>
            <div style="padding: 8px 12px; background: #1a1a1a; border: 1px solid #334155; border-radius: 4px; color: #94a3b8; font-size: 12px;">
              Outer: {outerError() ? 'üî• ERROR' : '‚úÖ OK'} | Inner: {innerError() ? 'üî• ERROR' : '‚úÖ OK'}
            </div>
          </div>
          
          <Tryer>
            {() => {
              console.log('Nested Outer Tryer rendering, outerError():', outerError(), 'innerError():', innerError());
              if (outerError()) {
                return <ErrorComponent message={() => 'Outer component failed!'} />;
              } else {
                return (
                  <div style="padding: 15px; background: #1a1a1a; border: 2px solid #f59e0b; border-radius: 4px;">
                    <div style="color: #f59e0b; font-weight: bold; margin-bottom: 10px;">Outer Boundary</div>
                    
                    <Tryer>
                      {() => {
                        console.log('Nested Inner Tryer rendering, innerError():', innerError());
                        if (innerError()) {
                          return <ErrorComponent message={() => 'Inner component failed!'} />;
                        } else {
                          return (
                            <div style="padding: 15px; background: #0a0a0a; border: 2px solid #8b5cf6; border-radius: 4px;">
                              <div style="color: #8b5cf6; font-weight: bold; margin-bottom: 10px;">Inner Boundary</div>
                              <div style="padding: 10px; background: #10b981; color: white; border-radius: 4px; text-align: center;">
                                ‚úì All components healthy
                              </div>
                            </div>
                          );
                        }
                      }}
                      
                      <Catcher>
                        {(error) => (
                          <div style="padding: 15px; background: #581c87; border-left: 4px solid #8b5cf6; border-radius: 4px; color: #e9d5ff;">
                            ‚ö†Ô∏è Inner boundary caught: {error.message}
                          </div>
                        )}
                      </Catcher>
                    </Tryer>
                  </div>
                );
              }
            }}
            
            <Catcher>
              {(error) => (
                <div style="padding: 15px; background: #78350f; border-left: 4px solid #f59e0b; border-radius: 4px; color: #fbbf24;">
                  ‚ö†Ô∏è Outer boundary caught: {error.message}
                </div>
              )}
            </Catcher>
          </Tryer>
        </div>
      </section>
      
      {/* Test 4: Error Recovery Pattern */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #ef4444;">
          4Ô∏è‚É£ Error Recovery Pattern
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Implement retry logic with error boundaries. Component succeeds after 3 attempts.
        </p>
        
        <div style="margin-bottom: 15px; padding: 10px; background: #0a0a0a; border: 1px solid #334155; border-radius: 4px; font-size: 12px; color: #94a3b8;">
          Status: Attempts {attemptCount()}/3 | {shouldFail() ? 'üî• Will Fail' : '‚úÖ Will Succeed'}
        </div>
        
        <div style="background: #0a0a0a; padding: 15px; border-radius: 4px;">
          <Tryer>
            {() => {
              console.log('Recovery Tryer rendering, attemptCount():', attemptCount(), 'shouldFail():', shouldFail());
              if (shouldFail()) {
                return <ErrorComponent message={() => `Attempt ${attemptCount() + 1}: Service temporarily unavailable`} />;
              } else {
                return (
                  <div style="padding: 20px; background: #10b981; color: white; border-radius: 4px; text-align: center;">
                    ‚úì Success! Component loaded after {attemptCount()} retries
                  </div>
                );
              }
            }}
            
            <Catcher>
              {(error, reset) => (
                <div style="padding: 20px; background: #7f1d1d; border-left: 4px solid #ef4444; border-radius: 4px;">
                  <h4 style="margin: 0 0 10px 0; color: #fca5a5; font-size: 16px;">
                    ‚ö†Ô∏è Loading Failed
                  </h4>
                  <p style="margin: 0 0 15px 0; color: #fecaca; font-size: 14px;">
                    {error.message}
                  </p>
                  <p style="margin: 0 0 15px 0; color: #94a3b8; font-size: 12px;">
                    Attempts: {attemptCount()} / 3 (succeeds on 3rd attempt)
                  </p>
                  <button
                    onclick={() => { 
                      console.log('Retry clicked, attemptCount:', attemptCount());
                      reset(); 
                      tryAgain(); 
                    }}
                    style="padding: 10px 20px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;"
                  >
                    {attemptCount() < 2 ? 'Retry' : 'Final Attempt'}
                  </button>
                </div>
              )}
            </Catcher>
          </Tryer>
        </div>
      </section>
      
      {/* Summary */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
        <h3 style="font-size: 20px; margin-bottom: 10px; color: #10b981;">
          ‚úì Error Boundary Summary
        </h3>
        <ul style="color: #94a3b8; line-height: 1.8; margin: 0; padding-left: 20px;">
          <li><strong style="color: white;">Tryer:</strong> Creates an error boundary context</li>
          <li><strong style="color: white;">Catcher:</strong> Renders when errors are caught, provides error and reset function</li>
          <li><strong style="color: white;">Isolation:</strong> Errors don't propagate beyond their boundary</li>
          <li><strong style="color: white;">Nesting:</strong> Inner boundaries catch first, outer as fallback</li>
          <li><strong style="color: white;">Recovery:</strong> reset() function to recover from errors</li>
          <li><strong style="color: white;">User Experience:</strong> Graceful degradation instead of white screen</li>
        </ul>
      </section>
    </div>
  );
}
