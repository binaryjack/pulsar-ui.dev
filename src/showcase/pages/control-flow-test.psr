/**
 * PHASE 2: Control Flow Primitives
 * Testing: For, Show, Index components
 */

import { createSignal, ForRegistry, ShowRegistry, Index } from '@pulsar-framework/pulsar.dev';

export component ControlFlowTestPage() {
  // Test 1: Show - Conditional rendering
  const [showContent, setShowContent] = createSignal(true);
  const [hasError, setHasError] = createSignal(false);
  
  const toggleContent = () => setShowContent(!showContent());
  const toggleError = () => setHasError(!hasError());
  
  // Test 2: For - List rendering with keyed items
  const [items, setItems] = createSignal([
    { id: 1, name: 'Apple', price: 1.99 },
    { id: 2, name: 'Banana', price: 0.99 },
    { id: 3, name: 'Cherry', price: 2.49 },
  ]);
  
  const addItem = () => {
    const currentItems = items();
    const ids = currentItems.map(i => i.id);
    let maxId = 0;
    for (let i = 0; i < ids.length; i++) {
      if (ids[i] > maxId) maxId = ids[i];
    }
    const newId = maxId + 1;
    const fruits = ['Orange', 'Grape', 'Mango', 'Pineapple', 'Strawberry'];
    const randomFruit = fruits[Math.floor(Math.random() * fruits.length)];
    const randomPrice = (Math.random() * 3 + 0.5).toFixed(2);
    
    setItems(currentItems.concat([{ id: newId, name: randomFruit, price: parseFloat(randomPrice) }]));
  };
  
  const removeItem = (id) => {
    setItems(items().filter(item => item.id !== id));
  };
  
  const sortByPrice = () => {
    const sorted = items().slice().sort((a, b) => a.price - b.price);
    setItems(sorted);
  };
  
  // Test 3: Index - Indexed iteration (by index, not key)
  const [colors, setColors] = createSignal(['Red', 'Green', 'Blue', 'Yellow']);
  
  const shuffleColors = () => {
    const shuffled = colors().slice();
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const temp = shuffled[i];
      shuffled[i] = shuffled[j];
      shuffled[j] = temp;
    }
    setColors(shuffled);
  };
  
  return (
    <div>
      <h2 style="font-size: 32px; margin-bottom: 20px; color: #f59e0b;">
        üéØ Phase 2: Control Flow Primitives
      </h2>
      
      {/* Test 1: Show Component */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #f59e0b;">
          1Ô∏è‚É£ Show - Conditional Rendering
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          The Show component renders children only when the condition is true. Supports fallback content.
        </p>
        
        <div style="background: #0a0a0a; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button 
              onClick={toggleContent}
              style="padding: 10px 20px; background: #f59e0b; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;">
              Toggle Content
            </button>
            
            <button 
              onClick={toggleError}
              style="padding: 10px 20px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;">
              Toggle Error
            </button>
          </div>
          
          <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; min-height: 80px;">
            <ShowRegistry when={showContent()} fallback={<p style="color: #ef4444;">Content is hidden</p>}>
              <div style="color: #10b981;">
                <p style="margin: 0 0 10px 0; font-size: 16px; font-weight: bold;">‚úì Content is visible!</p>
                <p style="margin: 0; color: #94a3b8;">This appears when showContent() is true.</p>
              </div>
            </ShowRegistry>
            
            <ShowRegistry when={hasError()}>
              <div style="margin-top: 15px; padding: 10px; background: #7f1d1d; border-left: 3px solid #ef4444; color: #fca5a5;">
                ‚ö†Ô∏è Error state is active!
              </div>
            </ShowRegistry>
          </div>
        </div>
        
        <div style="background: #0f172a; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #64748b;">
          State: showContent = {showContent() ? 'true' : 'false'}, hasError = {hasError() ? 'true' : 'false'}
        </div>
      </section>
      
      {/* Test 2: ForRegistry - Keyed List Rendering */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #f59e0b;">
          2Ô∏è‚É£ For - Keyed List Rendering
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          ForRegistry efficiently renders lists with proper keying for optimal updates and animations.
        </p>
        
        <div style="background: #0a0a0a; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button 
              onClick={addItem}
              style="padding: 10px 20px; background: #10b981; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;">
              Add Item
            </button>
            
            <button 
              onClick={sortByPrice}
              style="padding: 10px 20px; background: #3b82f6; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px;">
              Sort by Price
            </button>
          </div>
          
          <div style="display: grid; gap: 10px;">
            <ForRegistry each={items()} fallback={<p style="color: #64748b;">No items in cart</p>}>
              {(item) => (
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #1a1a1a; border-radius: 4px; border: 1px solid #334155;">
                  <div>
                    <span style="font-weight: bold; color: white; margin-right: 10px;">
                      {item.name}
                    </span>
                    <span style="color: #10b981; font-size: 18px;">
                      ${item.price.toFixed(2)}
                    </span>
                  </div>
                  
                  <button 
                    onClick={() => removeItem(item.id)}
                    style="padding: 6px 12px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">
                    Remove
                  </button>
                </div>
              )}
            </ForRegistry>
          </div>
          
          <div style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 4px;">
            <strong style="color: white;">Total Items: {items().length}</strong>
            <span style="margin-left: 20px; color: #10b981;">
              Total Cost: ${items().reduce((sum, item) => sum + item.price, 0).toFixed(2)}
            </span>
          </div>
        </div>
      </section>
      
      {/* Test 3: Index - Index-based Iteration */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #f59e0b;">
          3Ô∏è‚É£ Index - Index-based Iteration
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Index component iterates by array index (not by key). Useful when items have no stable identity.
        </p>
        
        <div style="background: #0a0a0a; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
          <button 
            onClick={shuffleColors}
            style="padding: 10px 20px; background: #8b5cf6; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; margin-bottom: 15px;">
            Shuffle Colors
          </button>
          
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <Index each={colors()}>
              {(color, index) => (
                <div style="padding: 15px 25px; background: #1a1a1a; border-radius: 4px; border: 2px solid #8b5cf6;">
                  <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">
                    Index: {index}
                  </div>
                  <div style="font-size: 18px; font-weight: bold; color: white;">
                    {color()}
                  </div>
                </div>
              )}
            </Index>
          </div>
          
          <div style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 4px; font-size: 12px; color: #94a3b8;">
            üí° Note: Index passes a signal for the value, and raw index number. 
            Items update in-place when array changes.
          </div>
        </div>
      </section>
      
      {/* Summary */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
        <h3 style="font-size: 20px; margin-bottom: 10px; color: #10b981;">
          ‚úì Control Flow Summary
        </h3>
        <ul style="color: #94a3b8; line-height: 1.8; margin: 0; padding-left: 20px;">
          <li><strong style="color: white;">Show:</strong> Conditional rendering with optional fallback</li>
          <li><strong style="color: white;">ForRegistry:</strong> Keyed iteration for lists with stable identities</li>
          <li><strong style="color: white;">Index:</strong> Index-based iteration for arrays without keys</li>
          <li><strong style="color: white;">Performance:</strong> Minimal re-renders, only affected items update</li>
        </ul>
      </section>
    </div>
  );
}
