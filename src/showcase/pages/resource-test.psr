/**
 * PHASE 3: Resource Management - COMPREHENSIVE DEMO
 * Demonstrates: Deduplication, Caching, Parallel Loading, Suspense, Progressive Images
 */

import { createSignal, createEffect, createResource, ShowRegistry, Waiting, resolveWaiting, Index } from '@pulsar-framework/pulsar.dev';

// Network tracking for demonstration
let networkRequestCount = 0;

// Mock API with network tracking
async function fetchUser(id) {
  const requestId = ++networkRequestCount;
  console.log(`[Network #${requestId}] Fetching user ${id}`);
  
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve({
        id,
        name: `User ${id}`,
        email: `user${id}@example.com`,
        avatar: `https://i.pravatar.cc/150?img=${id}`,
        requestId,
      });
    }, 1000);
  });
}

async function fetchPosts(userId) {
  const requestId = ++networkRequestCount;
  console.log(`[Network #${requestId}] Fetching posts for user ${userId}`);
  
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve([
        { id: 1, title: 'Getting Started with Pulsar', likes: 42 },
        { id: 2, title: 'Reactive Programming', likes: 38 },
      ]);
    }, 800);
  });
}

async function fetchActivity(userId) {
  const requestId = ++networkRequestCount;
  console.log(`[Network #${requestId}] Fetching activity for user ${userId}`);
  
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve({
        totalPosts: 156,
        followers: 1240,
        following: 89,
      });
    }, 600);
  });
}

async function loadImage(index) {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve(`https://picsum.photos/300/200?random=${index}`);
    }, Math.random() * 500 + 300);
  });
}

export component ResourceTestPage() {
  const [showDedupeDemo, setShowDedupeDemo] = createSignal(false);
  const [showCacheDemo, setShowCacheDemo] = createSignal(false);
  const [showWaitingDemo, setShowWaitingDemo] = createSignal(false);
  const [showImagesDemo, setShowImagesDemo] = createSignal(false);
  
  createEffect(() => {
    if (showDedupeDemo() || showCacheDemo() || showWaitingDemo()) {
      networkRequestCount = 0;
    }
  });
  
  return (
    <div>
      <h2 style="font-size: 32px; margin-bottom: 20px; color: #06b6d4;">
        üåä Resource Management: Real-World Features
      </h2>
      
      <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
        <h3 style="font-size: 20px; margin-bottom: 10px; color: #f59e0b;">
          ‚ö° What Makes Resources Different?
        </h3>
        <p style="color: #94a3b8; line-height: 1.6;">
          Resources provide <strong style="color: white;">deduplication</strong>, 
          <strong style="color: white;"> caching</strong>, <strong style="color: white;">parallel coordination</strong>, 
          and <strong style="color: white;">progressive loading</strong> out of the box.
        </p>
      </div>
      
      {/* Demo 1: Deduplication */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #06b6d4;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #06b6d4;">
          1Ô∏è‚É£ Request Deduplication
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          3 components request same resource = <strong style="color: #10b981;">1 network call</strong>, not 3.
        </p>
        
        <button 
          onClick={() => setShowDedupeDemo(!showDedupeDemo())}
          style="padding: 10px 20px; background: #06b6d4; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; margin-bottom: 15px;">
          {showDedupeDemo() ? 'üîÑ Reset' : '‚ñ∂Ô∏è Run Demo'}
        </button>
        
        <ShowRegistry when={() => showDedupeDemo()}>
          <DeduplicationDemo />
        </ShowRegistry>
      </section>
      
      {/* Demo 2: Stale-While-Revalidate */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #8b5cf6;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #8b5cf6;">
          2Ô∏è‚É£ Cache with Stale-While-Revalidate
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Serve cached data instantly, refetch in background. <strong style="color: #10b981;">0ms perceived load</strong>.
        </p>
        
        <button 
          onClick={() => setShowCacheDemo(!showCacheDemo())}
          style="padding: 10px 20px; background: #8b5cf6; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; margin-bottom: 15px;">
          {showCacheDemo() ? 'üîÑ Reset' : '‚ñ∂Ô∏è Run Demo'}
        </button>
        
        <ShowRegistry when={() => showCacheDemo()}>
          <CacheDemo />
        </ShowRegistry>
      </section>
      
      {/* Demo 3: Waiting/Suspense */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #10b981;">
          3Ô∏è‚É£ Suspense Boundaries
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Multiple resources coordinate - show skeleton until <strong style="color: #10b981;">all ready</strong>.
        </p>
        
        <button 
          onClick={() => setShowWaitingDemo(!showWaitingDemo())}
          style="padding: 10px 20px; background: #10b981; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; margin-bottom: 15px;">
          {showWaitingDemo() ? 'üîÑ Reset' : '‚ñ∂Ô∏è Run Demo'}
        </button>
        
        <ShowRegistry when={() => showWaitingDemo()}>
          <WaitingDemo />
        </ShowRegistry>
      </section>
      
      {/* Demo 4: Progressive Images */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
        <h3 style="font-size: 24px; margin-bottom: 15px; color: #f59e0b;">
          4Ô∏è‚É£ Progressive Image Gallery
        </h3>
        
        <p style="color: #94a3b8; margin-bottom: 15px;">
          Real-world demo: <strong style="color: #10b981;">Parallel loading</strong> with individual states.
        </p>
        
        <button 
          onClick={() => setShowImagesDemo(!showImagesDemo())}
          style="padding: 10px 20px; background: #f59e0b; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; margin-bottom: 15px;">
          {showImagesDemo() ? 'üîÑ Reset' : '‚ñ∂Ô∏è Load Gallery'}
        </button>
        
        <ShowRegistry when={() => showImagesDemo()}>
          <ImageGalleryDemo />
        </ShowRegistry>
      </section>
      
      {/* Summary */}
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
        <h3 style="font-size: 20px; margin-bottom: 10px; color: #10b981;">
          ‚úì Why Use Resources vs Manual Fetch?
        </h3>
        <div style="display: grid; gap: 15px; color: #94a3b8;">
          <div style="padding: 15px; background: #0a0a0a; border-radius: 4px;">
            <strong style="color: #06b6d4;">Deduplication:</strong> Multiple components, one request
          </div>
          <div style="padding: 15px; background: #0a0a0a; border-radius: 4px;">
            <strong style="color: #8b5cf6;">Cache + Stale Time:</strong> Instant UI, background refresh
          </div>
          <div style="padding: 15px; background: #0a0a0a; border-radius: 4px;">
            <strong style="color: #10b981;">Suspense Coordination:</strong> Wait for all data
          </div>
          <div style="padding: 15px; background: #0a0a0a; border-radius: 4px;">
            <strong style="color: #f59e0b;">Auto State Management:</strong> No manual tracking
          </div>
        </div>
      </section>
    </div>
  );
}

// DEMO COMPONENTS BELOW

component DeduplicationDemo() {
  const user1 = createResource(() => fetchUser(1));
  const user2 = createResource(() => fetchUser(1));
  const user3 = createResource(() => fetchUser(1));
  
  return (
    <div style="background: #0a0a0a; padding: 15px; border-radius: 4px;">
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
        <UserCard resource={user1} label="Component A" />
        <UserCard resource={user2} label="Component B" />
        <UserCard resource={user3} label="Component C" />
      </div>
      
      <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #10b981;">
        <div style="color: #10b981; font-weight: bold; margin-bottom: 5px;">
          üìä Network Efficiency
        </div>
        <div style="color: #94a3b8; font-size: 14px;">
          3 components requested data, only <strong style="color: #10b981;">1 network request</strong> made!
        </div>
      </div>
    </div>
  );
}

component UserCard({ resource, label }) {
  return (
    <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; border: 1px solid #334155;">
      <div style="color: #06b6d4; font-size: 12px; margin-bottom: 10px; font-weight: bold;">
        {label}
      </div>
      
      <ShowRegistry when={() => resource.isLoading}>
        <div style="text-align: center; padding: 20px; color: #64748b;">‚è≥</div>
      </ShowRegistry>
      
      <ShowRegistry when={() => !resource.isLoading && resource.data}>
        <div style="text-align: center;">
          <img 
            src={resource.data?.avatar} 
            alt={resource.data?.name}
            style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px;"
          />
          <div style="color: white; font-size: 14px; font-weight: bold;">
            {resource.data?.name}
          </div>
          <div style="color: #64748b; font-size: 11px; margin-top: 5px;">
            Request #{resource.data?.requestId}
          </div>
        </div>
      </ShowRegistry>
    </div>
  );
}

component CacheDemo() {
  const [fetchCount, setFetchCount] = createSignal(0);
  const [cacheHits, setCacheHits] = createSignal(0);
  
  const cachedResource = createResource(() => {
    setFetchCount(c => c + 1);
    return fetchUser(1);
  }, { staleTime: 5000 });
  
  const refetchWithCheck = () => {
    if (cachedResource.data && Date.now() - (cachedResource._lastFetchTime || 0) < 5000) {
      setCacheHits(h => h + 1);
    }
    cachedResource.refetch();
  };
  
  return (
    <div style="background: #0a0a0a; padding: 15px; border-radius: 4px;">
      <button 
        onClick={refetchWithCheck}
        style="padding: 10px 20px; background: #8b5cf6; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; margin-bottom: 15px;">
        üîÑ Refetch Data
      </button>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
        <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; text-align: center;">
          <div style="font-size: 32px; color: #ef4444; font-weight: bold;">{fetchCount()}</div>
          <div style="color: #94a3b8; font-size: 12px;">Network Requests</div>
        </div>
        
        <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; text-align: center;">
          <div style="font-size: 32px; color: #10b981; font-weight: bold;">{cacheHits()}</div>
          <div style="color: #94a3b8; font-size: 12px;">Cache Hits</div>
        </div>
      </div>
      
      <ShowRegistry when={() => cachedResource.data}>
        <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #8b5cf6;">
          <div style="color: #8b5cf6; font-weight: bold; margin-bottom: 10px;">üì¶ Cached (Fresh 5s)</div>
          <div style="display: flex; gap: 15px; align-items: center;">
            <img 
              src={cachedResource.data?.avatar} 
              alt={cachedResource.data?.name}
              style="width: 50px; height: 50px; border-radius: 50%;"
            />
            <div>
              <div style="color: white; font-weight: bold;">{cachedResource.data?.name}</div>
              <div style="color: #94a3b8; font-size: 12px;">{cachedResource.data?.email}</div>
            </div>
          </div>
          <div style="color: #64748b; font-size: 11px; margin-top: 10px;">
            üí° Refetch within 5s for instant cache hit!
          </div>
        </div>
      </ShowRegistry>
    </div>
  );
}

component WaitingDemo() {
  const userResource = createResource(() => fetchUser(1));
  const postsResource = createResource(() => fetchPosts(1));
  const activityResource = createResource(() => fetchActivity(1));
  
  const waitingContainer = (
    <Waiting default={<SuspenseSkeleton />}>
      <div style="padding: 15px; background: #1a1a1a; border-radius: 4px;">
        <div style="color: #10b981; font-weight: bold; margin-bottom: 10px;">‚úì All Resources Loaded!</div>
        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
          <img 
            src={userResource.data?.avatar} 
            alt={userResource.data?.name}
            style="width: 60px; height: 60px; border-radius: 50%;"
          />
          <div>
            <div style="color: white; font-weight: bold;">{userResource.data?.name}</div>
            <div style="color: #94a3b8; font-size: 12px;">{userResource.data?.email}</div>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
          <div style="text-align: center; padding: 10px; background: #0a0a0a; border-radius: 4px;">
            <div style="color: #06b6d4; font-size: 20px; font-weight: bold;">
              {activityResource.data?.totalPosts}
            </div>
            <div style="color: #94a3b8; font-size: 11px;">Posts</div>
          </div>
          <div style="text-align: center; padding: 10px; background: #0a0a0a; border-radius: 4px;">
            <div style="color: #06b6d4; font-size: 20px; font-weight: bold;">
              {activityResource.data?.followers}
            </div>
            <div style="color: #94a3b8; font-size: 11px;">Followers</div>
          </div>
          <div style="text-align: center; padding: 10px; background: #0a0a0a; border-radius: 4px;">
            <div style="color: #06b6d4; font-size: 20px; font-weight: bold;">
              {activityResource.data?.following}
            </div>
            <div style="color: #94a3b8; font-size: 11px;">Following</div>
          </div>
        </div>
        
        {postsResource.data?.map(post => (
          <div style="padding: 10px; background: #0a0a0a; border-radius: 4px; margin-bottom: 8px; border-left: 2px solid #06b6d4;">
            <div style="color: white; font-size: 13px;">{post.title}</div>
            <div style="color: #64748b; font-size: 11px;">‚ù§Ô∏è {post.likes} likes</div>
          </div>
        )) || []}
      </div>
    </Waiting>
  );
  
  createEffect(() => {
    if (!userResource.isLoading && !postsResource.isLoading && !activityResource.isLoading &&
        userResource.data && postsResource.data && activityResource.data) {
      resolveWaiting(waitingContainer);
    }
  });
  
  return (
    <div style="background: #0a0a0a; padding: 15px; border-radius: 4px;">
      {waitingContainer}
      
      <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #10b981; margin-top: 15px;">
        <div style="color: #64748b; font-size: 12px;">
          üí° Waiting coordinates 3 resources - skeleton until ALL loaded.
        </div>
      </div>
    </div>
  );
}

component SuspenseSkeleton() {
  return (
    <div style="padding: 15px; background: #1a1a1a; border-radius: 4px;">
      <div style="color: #06b6d4; margin-bottom: 15px;">‚è≥ Loading profile...</div>
      <div style="display: flex; gap: 15px; margin-bottom: 15px;">
        <div style="width: 60px; height: 60px; border-radius: 50%; background: #334155;"></div>
        <div style="flex: 1;">
          <div style="height: 16px; background: #334155; border-radius: 4px; margin-bottom: 8px; width: 40%;"></div>
          <div style="height: 12px; background: #334155; border-radius: 4px; width: 60%;"></div>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
        <div style="height: 60px; background: #334155; border-radius: 4px;"></div>
        <div style="height: 60px; background: #334155; border-radius: 4px;"></div>
        <div style="height: 60px; background: #334155; border-radius: 4px;"></div>
      </div>
    </div>
  );
}

component ImageGalleryDemo() {
  const imageResources = [
    createResource(() => loadImage(1)),
    createResource(() => loadImage(2)),
    createResource(() => loadImage(3)),
    createResource(() => loadImage(4)),
    createResource(() => loadImage(5)),
    createResource(() => loadImage(6))
  ];
  
  const [loadedCount, setLoadedCount] = createSignal(0);
  
  createEffect(() => {
    const loaded = imageResources.filter(r => r.isSuccess).length;
    setLoadedCount(loaded);
  });
  
  return (
    <div style="background: #0a0a0a; padding: 15px; border-radius: 4px;">
      <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <span style="color: #f59e0b; font-weight: bold;">Progress:</span>
            <span style="color: white; margin-left: 10px; font-size: 18px;">{loadedCount()} / 6</span>
          </div>
          <div style="width: 200px; height: 8px; background: #334155; border-radius: 4px; overflow: hidden;">
            <div style={`width: ${(loadedCount() / 6) * 100}%; height: 100%; background: #f59e0b; transition: width 0.3s;`}></div>
          </div>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
        <Index each={() => imageResources}>
          {(resource, index) => (
            <ImageCard resource={resource()} index={index + 1} />
          )}
        </Index>
      </div>
      
      <div style="padding: 15px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #f59e0b; margin-top: 15px;">
        <div style="color: #64748b; font-size: 12px;">
          üí° Parallel loading with individual states. Use: galleries, dashboards.
        </div>
      </div>
    </div>
  );
}

component ImageCard({ resource, index }) {
  return (
    <div style="aspect-ratio: 3/2; background: #1a1a1a; border-radius: 8px; overflow: hidden; position: relative;">
      <ShowRegistry when={() => resource.isLoading}>
        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #334155;">
          <div style="text-align: center;">
            <div style="color: #06b6d4; font-size: 24px; margin-bottom: 5px;">‚è≥</div>
            <div style="color: #94a3b8; font-size: 12px;">#{index}</div>
          </div>
        </div>
      </ShowRegistry>
      
      <ShowRegistry when={() => resource.isSuccess && resource.data}>
        <img 
          src={resource.data} 
          alt={`Image ${index}`}
          style="width: 100%; height: 100%; object-fit: cover;"
        />
        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 10px;">
          <div style="color: white; font-size: 12px; font-weight: bold;">Image #{index}</div>
        </div>
      </ShowRegistry>
    </div>
  );
}
