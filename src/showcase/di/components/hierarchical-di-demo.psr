/**
 * Hierarchical DI Demo
 * Shows parent/child ServiceManager containers
 */

import { createSignal } from '@pulsar-framework/pulsar.dev';
import { ServiceManager } from '@pulsar-framework/pulsar.dev';
import { ConsoleLogViewer } from '../../common/components/console-log-viewer.psr';
import { useLogger } from '../../common/hooks/use-logger.ts';

export component HierarchicalDiDemo() {
  const [ran, setRan] = createSignal(false);
  const logger = useLogger('[HierarchicalDI]');

  const runDemo = () => {
    logger.clear();

    // Parent container â€” global/app-level services
    const parent = new ServiceManager();
    parent.register('config', () => ({
      appName: 'PulsarApp',
      version: '2.0',
      apiUrl: 'https://api.example.com'
    }), { lifetime: 'singleton' });

    logger.log('âœ… Parent container created');
    logger.log('   Registered: config (singleton)');

    // Child container â€” scoped/request-level services
    const child = new ServiceManager(parent);
    child.register('session', () => ({
      userId: 'usr_42',
      token: 'eyJ...',
      expiresAt: Date.now() + 3600000
    }), { lifetime: 'scoped' });

    logger.log('âœ… Child container created (parent: appServices)');
    logger.log('   Registered: session (scoped)');

    // Resolution
    const configFromParent = parent.resolve('config');
    logger.log(`\nğŸ“¦ parent.resolve('config')  â†’  ${configFromParent.appName} v${configFromParent.version}`);

    try {
      parent.resolve('session');
    } catch {
      logger.warn(`âš ï¸  parent.resolve('session')  â†’  Not found (as expected)`);
    }

    const configFromChild = child.resolve('config');
    logger.log(`ğŸ“¦ child.resolve('config')   â†’  inherited from parent: ${configFromChild.apiUrl}`);

    const session = child.resolve('session');
    logger.log(`ğŸ“¦ child.resolve('session')  â†’  userId: ${session.userId}`);

    logger.log('\nğŸ‰ Hierarchical resolution complete!');
    setRan(true);
  };

  return (
    <div>
      <div style="margin-bottom: 16px; padding: 14px; background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.25); border-radius: 8px;">
        <p style="margin: 0 0 8px 0; color: #a7f3d0; font-size: 13px; line-height: 1.6;">
          Click <strong>Run Demo</strong> to see two service containers â€” a parent (app-level) and a child (request-level).
          The child inherits all parent services automatically.
        </p>
        <button
          onClick={runDemo}
          style="padding: 9px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px;">
          â–¶ Run Demo
        </button>
      </div>

      <ConsoleLogViewer
        logs={logger.logs}
        onClear={logger.clear}
        title="Container Resolution Log"
      />
    </div>
  );
}
