/**
 * PHASE 1: Core Reactivity Tests
 * Refactored with modular components
 */

import { createSignal, createEffect, createMemo, batch } from '@pulsar-framework/pulsar.dev';
import { PageHeader } from '../common/components/page-header.psr';
import { DemoSection } from '../common/components/demo-section.psr';
import { SignalDemo } from './components/signal-demo.psr';
import { MemoDemo } from './components/memo-demo.psr';
import { EffectDemo } from './components/effect-demo.psr';
import { BatchDemo } from './components/batch-demo.psr';
import { ConsoleLogViewer } from '../common/components/console-log-viewer.psr';
import type { LogEntry } from '../common/components/console-log-viewer.psr';

export component ReactivityTestPage() {
  // Signals
  const [firstName, setFirstName] = createSignal('John');
  const [lastName, setLastName] = createSignal('Doe');
  const [age, setAge] = createSignal(25);
  
  // Memos
  const fullName = createMemo(() => `${firstName()} ${lastName()}`);
  const isAdult = createMemo(() => age() >= 18);
  
  // Effect run counter for batch demo
  const [effectRunCount, setEffectRunCount] = createSignal(0);
  const [effectLogs, setEffectLogs] = createSignal<LogEntry[]>([]);
  
  const addEffectLog = (message: string) => {
    const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
    setEffectLogs(logs => [...logs, { timestamp, level: 'log', message }]); // Use updater to avoid tracking effectLogs in effect
  };
  
  const clearEffectLogs = () => setEffectLogs([]);
  
  // Effects
  createEffect(() => {
    const name = fullName(); // Track fullName changes ONLY (don't track effectRunCount to avoid infinite loop)
    setEffectRunCount(c => c + 1); // Use updater function, don't read current value
    const message = `ðŸ”„ Effect executed - Full name: ${name}`;
    addEffectLog(message);
    console.log(`[Effect] Full name changed to: ${name}`);
  });
  
  // Batch handlers
  const updateAll = () => {
    batch(() => {
      setFirstName('Jane');
      setLastName('Smith');
      setAge(30);
    });
  };
  
  const resetAll = () => {
    batch(() => {
      setFirstName('John');
      setLastName('Doe');
      setAge(25);
    });
  };
  
  return (
    <div>
      <PageHeader 
        title="Core Reactivity Tests"
        emoji="ðŸ§ª"
        color="#10b981"
        description="Testing signals, effects, memos, and hooks"
      />
      
      <DemoSection 
        title="1ï¸âƒ£ Multiple Signals" 
        description="Create and manage multiple reactive signals"
        borderColor="#3b82f6">
        <SignalDemo 
          firstName={firstName}
          setFirstName={setFirstName}
          lastName={lastName}
          setLastName={setLastName}
          age={age}
          setAge={setAge}
        />
      </DemoSection>
      
      <DemoSection 
        title="2ï¸âƒ£ Computed Values (Memos)" 
        description="Derived values that auto-update when dependencies change"
        borderColor="#8b5cf6">
        <MemoDemo fullName={fullName} isAdult={isAdult} />
      </DemoSection>
      
      <DemoSection 
        title="3ï¸âƒ£ Side Effects (createEffect)" 
        description="Run code in response to signal changes"
        borderColor="#10b981">
        <EffectDemo />
      </DemoSection>
      
      <DemoSection 
        title="4ï¸âƒ£ Batched Updates" 
        description="Update multiple signals without triggering intermediate effects"
        borderColor="#f59e0b">
        <BatchDemo 
          updateAll={updateAll} 
          resetAll={resetAll} 
          effectRunCount={effectRunCount}
        />
      </DemoSection>
      
      <DemoSection 
        title="ðŸ“Š Effect Execution Monitor" 
        description="Real-time tracking of effect runs (watch the counter grow as you change firstName/lastName)"
        borderColor="#10b981">
        <div style="padding: 15px; background: #1a1a1a; border-radius: 6px; margin-bottom: 15px;">
          <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px;">
            <div style="font-size: 48px; font-weight: bold; color: white; margin-bottom: 10px;">
              {effectRunCount()}
            </div>
            <div style="color: white; font-size: 16px;">
              Total Effect Executions
            </div>
          </div>
        </div>
        <ConsoleLogViewer 
          logs={effectLogs} 
          onClear={clearEffectLogs}
          title="Effect Execution History"
          maxHeight="250px"
        />
      </DemoSection>
      
      <section style="background: #1a1a1a; padding: 20px; border-radius: 8px; border: 2px solid #10b981;">
        <h3 style="font-size: 20px; margin-bottom: 15px; color: #10b981;">
          âœ… Test Status
        </h3>
        <ul style="list-style: none; padding: 0; color: #9ca3af;">
          <li style="margin-bottom: 8px;">âœ… Multiple signals working</li>
          <li style="margin-bottom: 8px;">âœ… Memos (computed values)</li>
          <li style="margin-bottom: 8px;">âœ… Effects (side effects)</li>
          <li style="margin-bottom: 8px;">âœ… Batch updates</li>
        </ul>
      </section>
    </div>
  );
}
