<!doctype html>
<html>
  <head>
    <title>TRACE BOOTSTRAP</title>
    <style>
      body {
        background: #000;
        color: #0f0;
        padding: 20px;
        font-family: monospace;
        font-size: 12px;
      }
      .step {
        margin: 2px 0;
      }
      .error {
        color: #f00;
        font-weight: bold;
      }
      .success {
        color: #0ff;
      }
    </style>
  </head>
  <body>
    <h1>TRACING BOOTSTRAP STEP-BY-STEP</h1>
    <div id="trace"></div>
    <hr />
    <h2>APP CONTAINER (should have content):</h2>
    <div id="app" style="border: 2px solid red; padding: 20px; min-height: 200px"></div>

    <script type="module">
      const trace = document.getElementById('trace');

      // Save original console.log FIRST
      const originalLog = console.log;

      const log = (msg, isError = false, isSuccess = false) => {
        const div = document.createElement('div');
        div.className = 'step' + (isError ? ' error' : '') + (isSuccess ? ' success' : '');
        div.textContent = `[${new Date().toISOString().substr(11, 12)}] ${msg}`;
        trace.appendChild(div);
        originalLog(msg); // Use originalLog to avoid infinite loop!
      };

      // Intercept console logs from bootstrap
      console.log = (...args) => {
        if (args[0] && typeof args[0] === 'string' && args[0].includes('[Bootstrap]')) {
          log(`BOOTSTRAP: ${args.join(' ')}`, false, true);
        }
        originalLog(...args);
      };

      log('‚ñ∂ Starting bootstrap trace...');

      try {
        log('1. Importing bootstrapAppConfig...');
        const { bootstrapAppConfig } = await import('@pulsar-framework/pulsar.dev');
        log('2. ‚úÖ bootstrapAppConfig imported');

        log('3. Importing AvatarTest component...');
        const { AvatarTest } = await import('./src/test-psr-avatar.psr');
        log(`4. ‚úÖ AvatarTest imported, type: ${typeof AvatarTest}`);

        log('5. Testing component directly first...');
        const testResult = AvatarTest();
        log(`6. Direct call result: ${testResult ? 'HTMLElement' : 'null/undefined'}`);
        log(`   nodeType: ${testResult?.nodeType}, tagName: ${testResult?.tagName}`);

        log('7. Calling bootstrapAppConfig...');
        const app = bootstrapAppConfig({
          root: '#app',
          component: AvatarTest,
          props: {},
          onMount: (el) => {
            log('üéâ onMount callback fired!', false, true);
            log(`   Mounted element: ${el.tagName}`, false, true);
          },
          onError: (err) => {
            log(`‚ùå onError callback: ${err.message}`, true);
            log(`   Stack: ${err.stack}`, true);
          },
        });

        log('8. ‚úÖ bootstrapAppConfig returned');
        log(`9. Checking #app children count: ${document.getElementById('app').childElementCount}`);

        setTimeout(() => {
          const count = document.getElementById('app').childElementCount;
          if (count > 0) {
            log(`‚úÖ SUCCESS! #app has ${count} children`, false, true);
          } else {
            log(`‚ùå FAILED! #app is still empty`, true);
          }
        }, 1000);
      } catch (err) {
        log(`‚ùå FATAL ERROR: ${err.message}`, true);
        log(`   Stack: ${err.stack}`, true);
      }
    </script>
  </body>
</html>
